<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>What To Prompt? - AI Prompt Engineering</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .message-bubble {
      animation: slideUp 0.3s ease-out;
      max-width: 100%;
      word-wrap: break-word;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-bubble {
      background: #000;
      color: white;
      padding: 0.875rem 1rem;
      border-radius: 1rem 1rem 0.25rem 1rem;
      margin-left: auto;
      max-width: 85%;
    }

    @media (max-width: 640px) {
      .user-bubble {
        max-width: 95%;
        padding: 0.75rem 0.875rem;
      }
    }

    .assistant-bubble {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 0.875rem 1rem;
      border-radius: 1rem 1rem 1rem 0.25rem;
      margin-right: auto;
      max-width: 85%;
    }

    @media (max-width: 640px) {
      .assistant-bubble {
        max-width: 95%;
        padding: 0.75rem 0.875rem;
      }
    }

    .typing-indicator {
      display: flex;
      gap: 0.25rem;
      padding: 1rem;
    }

    .typing-indicator .dot {
      width: 8px;
      height: 8px;
      background: #6b7280;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator .dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-indicator .dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes bounce {
      0%, 80%, 100% {
        transform: scale(0);
      }
      40% {
        transform: scale(1);
      }
    }

    .gradient-btn {
      background: linear-gradient(135deg, #3b3b3b 0%, #1a1a1a 100%);
      transition: all 0.2s ease;
    }

    .gradient-btn:hover {
      background: linear-gradient(135deg, #4b4b4b 0%, #2a2a2a 100%);
    }

    .gradient-btn:active {
      transform: scale(0.98);
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      line-height: 1.6;
      letter-spacing: 0.01em;
    }
    
    .assistant-bubble p {
        /* Styles for conversational text */
        font-size: 15px;
        line-height: 1.6;
        white-space: pre-wrap;
    }

    @media (max-width: 640px) {
      pre, .assistant-bubble p {
        font-size: 13px;
        line-height: 1.5;
      }
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    .sidebar {
      width: 320px;
      min-width: 320px;
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 280px;
        min-width: 280px;
        z-index: 100;
        transform: translateX(-100%);
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      .mobile-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 99;
      }

      .mobile-overlay.active {
        display: block;
      }

      .mobile-menu-btn {
        display: flex;
      }

      .desktop-only {
        display: none !important;
      }

      .tooltip .tooltiptext {
        display: none !important;
      }
    }

    @media (min-width: 769px) {
      .mobile-menu-btn {
        display: none;
      }
      
      .mobile-only {
        display: none !important;
      }
    }

    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #1f2937;
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.75rem;
      line-height: 1.4;
    }

    .tooltip .tooltiptext.right-aligned {
      left: auto;
      right: 0;
      margin-left: 0;
    }

    .tooltip .tooltiptext.left-aligned {
      left: 0;
      margin-left: 0;
    }

    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #1f2937 transparent transparent transparent;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    #scroll-to-top {
      transition: all 0.3s ease;
    }

    #scroll-to-top.show {
      opacity: 1;
      pointer-events: auto;
    }

    @media (max-width: 640px) {
      #scroll-to-top {
        bottom: 90px;
        right: 16px;
        padding: 0.625rem;
      }
      
      #scroll-to-top svg {
        width: 20px;
        height: 20px;
      }
    }

    .tutorial-slide {
      animation: fadeInSlide 0.4s ease-out;
    }

    @keyframes fadeInSlide {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .template-card {
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .template-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #9ca3af;
    }

    @media (max-width: 640px) {
      .template-card:active {
        transform: scale(0.98);
      }
    }

    .kbd {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 0.75rem;
      font-family: monospace;
    }

    .mode-btn {
      transition: all 0.2s ease;
    }

    .mode-btn.active {
      background: #000;
      color: white;
    }

    .mode-btn:not(.active):hover {
      background: #f9fafb;
    }

    @media (max-width: 768px) {
      .mobile-input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #e5e7eb;
        padding: 12px;
        z-index: 50;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      }

      .chat-container-mobile {
        padding-bottom: 90px !important;
      }
    }

    /* New CSS for Toast Animation */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -20px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }
    
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }
    /* End New CSS for Toast Animation */
  </style>
</head>
<body class="bg-white h-screen flex flex-col overflow-hidden">

  <div id="mobile-overlay" class="mobile-overlay"></div>

  <div id="tutorial-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden px-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden">
      <div id="tutorial-content" class="p-6 md:p-8">
        <div class="tutorial-slide" data-slide="1">
          <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center text-white font-bold text-4xl mb-6 mx-auto">?</div>
          <h2 class="text-2xl md:text-3xl font-bold text-center mb-4">Welcome to What To Prompt!</h2>
          <p class="text-gray-600 text-center mb-6 text-sm md:text-base">Learn how to create amazing AI prompts in just a few steps. This quick guide will show you everything you need to know!</p>
          <div class="text-center text-sm text-gray-500">Slide 1 of 4</div>
        </div>
        <div class="tutorial-slide hidden" data-slide="2">
          <div class="text-5xl text-center mb-6">üé®</div>
          <h2 class="text-xl md:text-2xl font-bold text-center mb-4">Choose Your Mode</h2>
          <div class="space-y-4 mb-6">
            <div class="p-4 bg-gray-50 rounded-lg">
              <h3 class="font-semibold mb-2">üìù Visual Builder</h3>
              <p class="text-sm text-gray-600">Fill in structured fields like Role, Task, Context, and Constraints. Perfect for detailed prompts!</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
              <h3 class="font-semibold mb-2">üí¨ Guided Chat</h3>
              <p class="text-sm text-gray-600">Chat with AI to refine your prompt ideas. The AI helps you create the perfect prompt through conversation!</p>
            </div>
          </div>
          <div class="text-center text-sm text-gray-500">Slide 2 of 4</div>
        </div>
        <div class="tutorial-slide hidden" data-slide="3">
          <div class="text-5xl text-center mb-6">‚ö°</div>
          <h2 class="text-xl md:text-2xl font-bold text-center mb-4">Try Example Templates</h2>
          <p class="text-gray-600 text-center mb-4 text-sm md:text-base">Click any example template to get started instantly!</p>
          <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <ul class="text-sm text-gray-700 space-y-2">
              <li>‚Ä¢ Write blog posts and articles</li>
              <li>‚Ä¢ Create code and scripts</li>
              <li>‚Ä¢ Design marketing campaigns</li>
              <li>‚Ä¢ Craft professional emails</li>
            </ul>
          </div>
          <div class="text-center text-sm text-gray-500">Slide 3 of 4</div>
        </div>
        <div class="tutorial-slide hidden" data-slide="4">
          <div class="text-5xl text-center mb-6">‚å®Ô∏è</div>
          <h2 class="text-xl md:text-2xl font-bold text-center mb-4">Keyboard Shortcuts</h2>
          <p class="text-gray-600 text-center mb-4 text-sm md:text-base">Work faster with these shortcuts:</p>
          <div class="bg-gray-50 rounded-lg p-4 mb-6 space-y-2 text-sm">
            <div class="flex justify-between items-center">
              <span>Send message</span>
              <span class="kbd">Ctrl + Enter</span>
            </div>
            <div class="flex justify-between items-center">
              <span>Clear chat</span>
              <span class="kbd">Ctrl + K</span>
            </div>
          </div>
          <div class="text-center text-sm text-gray-500">Slide 4 of 4</div>
        </div>
      </div>
      <div class="bg-gray-50 px-6 md:px-8 py-4 flex items-center justify-between border-t">
        <button id="tutorial-skip" class="text-sm text-gray-600 hover:text-black font-medium">Skip</button>
        <div class="flex gap-2">
          <button id="tutorial-prev" class="px-3 md:px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-100 font-medium hidden">Previous</button>
          <button id="tutorial-next" class="px-4 md:px-6 py-2 text-sm bg-black text-white rounded-lg hover:bg-gray-800 font-medium">Next</button>
        </div>
      </div>
    </div>
  </div>

  <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden px-4">
    <div class="bg-white p-6 md:p-8 rounded-lg shadow-2xl max-w-md w-full">
      <h2 class="text-xl md:text-2xl font-semibold mb-3">Privacy Notice</h2>
      <p class="text-gray-600 mb-6 text-sm md:text-base">‚ö†Ô∏è Please do not share personal, financial, or password information. This tool is for safe prompt generation only.</p>
      <div class="flex items-center mb-6">
        <input type="checkbox" id="dismiss-forever" class="w-4 h-4 rounded focus:ring-gray-500" />
        <label for="dismiss-forever" class="ml-2 text-sm text-gray-600">Don't show this again</label>
      </div>
      <button id="close-modal-btn" class="w-full gradient-btn text-white px-6 py-3 rounded-lg font-medium">Understood</button>
    </div>
  </div>

  <button id="scroll-to-top" class="fixed bottom-6 right-6 bg-black text-white p-3 rounded-full shadow-lg hover:bg-gray-800 transition opacity-0 pointer-events-none z-40">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg>
  </button>

  <header class="border-b border-gray-200 bg-white flex-shrink-0">
    <div class="px-4 md:px-6 py-3 md:py-4 flex items-center justify-between">
      <div class="flex items-center gap-2 md:gap-3">
        <button id="mobile-menu-btn" class="mobile-menu-btn p-2 -ml-2 text-gray-600 hover:text-black md:hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
        
        <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center text-white font-bold text-xl md:text-2xl">?</div>
        <div>
          <h1 class="text-base md:text-xl font-semibold">What To Prompt?</h1>
          <p class="text-xs text-gray-500 hidden sm:block">AI-Powered Prompt Engineering</p>
        </div>
      </div>
      <button id="help-btn" class="text-gray-600 hover:text-black text-xs md:text-sm font-medium">Help</button>
    </div>
  </header>

  <div id="help-drawer" class="hidden fixed right-4 top-16 md:top-20 bg-white rounded-lg shadow-xl border border-gray-200 p-4 md:p-6 w-72 md:w-80 z-50">
    <h3 class="font-semibold text-base md:text-lg mb-3">Keyboard Shortcuts</h3>
    <div class="space-y-2 text-sm text-gray-600 mb-4">
      <div class="flex justify-between"><span>Send message</span><span class="kbd">Ctrl+Enter</span></div>
      <div class="flex justify-between"><span>Clear chat</span><span class="kbd">Ctrl+K</span></div>
    </div>
    <button onclick="document.getElementById('tutorial-modal').classList.remove('hidden')" class="mt-2 w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition">Show Tutorial Again</button>
    <button onclick="document.getElementById('help-drawer').classList.add('hidden')" class="mt-2 w-full text-sm text-gray-600 hover:text-black font-medium">Close</button>
  </div>

  <div class="flex flex-1 overflow-hidden">
    <div id="sidebar" class="sidebar border-r border-gray-200 bg-gray-50 flex flex-col overflow-hidden">
      <div class="mobile-only p-4 border-b border-gray-200 flex items-center justify-between">
        <span class="font-semibold">Menu</span>
        <button id="close-sidebar-btn" class="p-2 text-gray-600 hover:text-black">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="p-4 flex-shrink-0 overflow-y-auto flex-1">
        <div class="mb-6">
          <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wider">Mode</label>
          <div class="flex rounded-lg bg-white border border-gray-200 overflow-hidden">
            <button type="button" id="visual-mode-btn" class="mode-btn flex-1 px-3 md:px-4 py-2.5 text-sm font-medium border-r border-gray-200">Visual</button>
            <button type="button" id="guided-mode-btn" class="mode-btn active flex-1 px-3 md:px-4 py-2.5 text-sm font-medium">Guided</button>
          </div>
        </div>

        <form id="visual-form" class="space-y-4 hidden">
          <div>
            <div class="flex items-center gap-1 mb-2">
              <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Role</label>
              <div class="tooltip desktop-only">
                <span class="text-gray-400 cursor-help text-xs">?</span>
                <span class="tooltiptext">What role should the AI act as? e.g., "Senior Developer", "Marketing Expert"</span>
              </div>
            </div>
            <textarea id="role-input" rows="2" placeholder="e.g., Senior Developer" class="w-full px-3 py-2 text-sm rounded-md border border-gray-300 focus:border-black focus:ring-1 focus:ring-black transition resize-none"></textarea>
          </div>
          <div>
            <div class="flex items-center gap-1 mb-2">
              <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Task *</label>
              <div class="tooltip desktop-only">
                <span class="text-gray-400 cursor-help text-xs">?</span>
                <span class="tooltiptext">What do you want the AI to do? Be specific about the main goal.</span>
              </div>
            </div>
            <textarea id="task-input" rows="2" placeholder="e.g., Write a Python function" class="w-full px-3 py-2 text-sm rounded-md border border-gray-300 focus:border-black focus:ring-1 focus:ring-black transition resize-none"></textarea>
          </div>
          <div>
            <div class="flex items-center gap-1 mb-2">
              <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Context</label>
              <div class="tooltip desktop-only">
                <span class="text-gray-400 cursor-help text-xs">?</span>
                <span class="tooltiptext">Background information or details that help the AI understand your needs better.</span>
              </div>
            </div>
            <textarea id="context-input" rows="2" placeholder="e.g., For a web application" class="w-full px-3 py-2 text-sm rounded-md border border-gray-300 focus:border-black focus:ring-1 focus:ring-black transition resize-none"></textarea>
          </div>
          <div>
            <div class="flex items-center gap-1 mb-2">
              <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Constraints</label>
              <div class="tooltip desktop-only">
                <span class="text-gray-400 cursor-help text-xs">?</span>
                <span class="tooltiptext">Any limitations or requirements? e.g., "Use only vanilla JavaScript", "Keep under 100 words"</span>
              </div>
            </div>
            <textarea id="constraints-input" rows="2" placeholder="e.g., Use TypeScript" class="w-full px-3 py-2 text-sm rounded-md border border-gray-300 focus:border-black focus:ring-1 focus:ring-black transition resize-none"></textarea>
          </div>
          <button type="submit" class="w-full gradient-btn text-white px-4 py-3 rounded-md font-medium text-sm">Generate Prompt</button>
        </form>

        <div id="guided-form-container" class="desktop-only">
          <form id="guided-form" class="relative">
            <input id="guided-input" type="text" class="w-full px-4 py-3 pr-12 text-sm rounded-md border border-gray-300 focus:border-black focus:ring-1 focus:ring-black transition" placeholder="Type your idea..." />
            <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black text-white rounded p-2 hover:bg-gray-800 transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </button>
          </form>
        </div>

        <div id="loading-spinner" class="hidden mt-3 flex justify-center">
          <div class="flex items-center gap-2 text-gray-600">
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
            </svg>
            <span class="text-xs font-medium">Generating...</span>
          </div>
        </div>
      </div>

      <div class="mt-auto p-4 border-t border-gray-200 bg-white space-y-3 flex-shrink-0">
        <div>
          <label class="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wider">AI Model</label>
          <select id="model-selector" class="w-full px-3 py-2 text-sm rounded-md border border-gray-300 focus:border-black focus:ring-1 focus:ring-black transition bg-white">
            <option value="google/gemini-flash-1.5-8b">Google - Gemini Flash 1.5 8B</option>
            <option value="google/gemini-2.0-flash-exp:free">Google - Gemini 2.0 Flash (Free)</option>
            <option value="anthropic/claude-3-haiku">Anthropic - Claude 3 Haiku</option>
            <option value="anthropic/claude-3.5-sonnet">Anthropic - Claude 3.5 Sonnet</option>
            <option value="meta-llama/llama-3.1-8b-instruct:free">Meta - Llama 3.1 8B (Free)</option>
            <option value="openai/gpt-4o-mini">OpenAI - GPT-4o Mini</option>
            <option value="openai/gpt-4o">OpenAI - GPT-4o</option>
          </select>
        </div>
        <button type="button" id="clear-chat-btn" class="w-full px-3 py-2 text-sm rounded-md border border-gray-300 hover:bg-gray-50 hover:border-red-400 hover:text-red-600 transition font-medium">Clear Chat</button>
      </div>
    </div>

    <div class="flex-1 flex flex-col overflow-hidden bg-white">
      <div id="chat-container" class="flex-1 overflow-y-auto px-4 md:px-8 py-4 md:py-6 chat-container-mobile">
        <div class="max-w-4xl mx-auto">
          <div id="chat-inner" class="flex flex-col gap-3">
            <div id="placeholder" class="flex flex-col items-center justify-center min-h-[300px] md:min-h-[400px] text-center px-4">
              <div class="w-16 h-16 md:w-20 md:h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center text-white font-bold text-4xl md:text-5xl mb-4 md:mb-6">?</div>
              <h2 class="text-xl md:text-2xl font-semibold text-gray-900 mb-2">Ready to Create Prompts</h2>
              <p class="text-gray-500 text-sm mb-6 md:mb-8">Choose a mode above or try an example below</p>
              
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-2xl">
                <div class="template-card p-3 md:p-4 border-2 border-gray-200 rounded-lg bg-white" data-template="blog">
                  <div class="text-2xl mb-2">üìù</div>
                  <h3 class="font-semibold text-sm mb-1">Write a Blog Post</h3>
                  <p class="text-xs text-gray-600">Create engaging content about any topic</p>
                </div>
                <div class="template-card p-3 md:p-4 border-2 border-gray-200 rounded-lg bg-white" data-template="code">
                  <div class="text-2xl mb-2">üíª</div>
                  <h3 class="font-semibold text-sm mb-1">Generate Code</h3>
                  <p class="text-xs text-gray-600">Build functions, scripts, or applications</p>
                </div>
                <div class="template-card p-3 md:p-4 border-2 border-gray-200 rounded-lg bg-white" data-template="marketing">
                  <div class="text-2xl mb-2">üéØ</div>
                  <h3 class="font-semibold text-sm mb-1">Marketing Campaign</h3>
                  <p class="text-xs text-gray-600">Design promotional content and strategies</p>
                </div>
                <div class="template-card p-3 md:p-4 border-2 border-gray-200 rounded-lg bg-white" data-template="email">
                  <div class="text-2xl mb-2">‚úâÔ∏è</div>
                  <h3 class="font-semibold text-sm mb-1">Professional Email</h3>
                  <p class="text-xs text-gray-600">Craft clear and effective emails</p>
                </div>
              </div>
            </div>
            <div id="chat-anchor"></div>
          </div>
        </div>
      </div>

      <div class="mobile-input-container mobile-only">
        <form id="guided-form-mobile" class="relative">
          <input id="guided-input-mobile" type="text" class="w-full px-4 py-3 pr-12 text-sm rounded-lg border border-gray-300 focus:border-black focus:ring-1 focus:ring-black transition" placeholder="Type your idea..." />
          <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black text-white rounded p-2 hover:bg-gray-800 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
          </button>
        </form>
      </div>

      <footer class="desktop-only border-t border-gray-200 py-3 px-8 bg-gray-50">
        <div class="max-w-4xl mx-auto flex items-center justify-center gap-2 text-xs text-gray-600">
          <span>¬© 2025</span>
          <a href="http://allensamuel.me/" target="_blank" class="font-medium hover:text-black transition">Allen Samuel</a>
        </div>
      </footer>
    </div>
  </div>

  <script>
    const API_URL = 'https://prompt-alchemist.onrender.com/api/v1/chat';
    let conversationHistory = [];
    let currentMode = 'guided';
    let currentTutorialSlide = 1;

    const chatInner = document.getElementById('chat-inner');
    const visualForm = document.getElementById('visual-form');
    const guidedForm = document.getElementById('guided-form');
    const guidedFormMobile = document.getElementById('guided-form-mobile');
    const roleInput = document.getElementById('role-input');
    const taskInput = document.getElementById('task-input');
    const contextInput = document.getElementById('context-input');
    const constraintsInput = document.getElementById('constraints-input');
    const guidedInput = document.getElementById('guided-input');
    const guidedInputMobile = document.getElementById('guided-input-mobile');
    const visualModeBtn = document.getElementById('visual-mode-btn');
    const guidedModeBtn = document.getElementById('guided-mode-btn');
    const modelSelector = document.getElementById('model-selector');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const spinner = document.getElementById('loading-spinner');
    const helpBtn = document.getElementById('help-btn');
    const helpDrawer = document.getElementById('help-drawer');
    const scrollToTopBtn = document.getElementById('scroll-to-top');
    const chatContainer = document.getElementById('chat-container');
    
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const sidebar = document.getElementById('sidebar');
    const mobileOverlay = document.getElementById('mobile-overlay');

    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.add('mobile-open');
        mobileOverlay.classList.add('active');
      });
    }

    if (closeSidebarBtn) {
      closeSidebarBtn.addEventListener('click', () => {
        sidebar.classList.remove('mobile-open');
        mobileOverlay.classList.remove('active');
      });
    }

    if (mobileOverlay) {
      mobileOverlay.addEventListener('click', () => {
        sidebar.classList.remove('mobile-open');
        mobileOverlay.classList.remove('active');
      });
    }

    const templates = {
      blog: {
        role: 'Professional Content Writer',
        task: 'Write an engaging blog post',
        context: 'For a technology blog targeting young professionals',
        constraints: 'Keep it between 800-1000 words, use conversational tone, include actionable tips'
      },
      code: {
        role: 'Senior Software Engineer',
        task: 'Write a Python function',
        context: 'For a web application that processes user data',
        constraints: 'Use type hints, include error handling, add documentation'
      },
      marketing: {
        role: 'Digital Marketing Specialist',
        task: 'Create a social media campaign',
        context: 'For a new product launch targeting millennials',
        constraints: 'Focus on Instagram and TikTok, use trending formats, include hashtag strategy'
      },
      email: {
        role: 'Professional Business Communicator',
        task: 'Write a professional email',
        context: 'For business correspondence with clients or colleagues',
        constraints: 'Keep it concise, maintain professional tone, clear call-to-action'
      }
    };

    const tutorialModal = document.getElementById('tutorial-modal');
    const tutorialNext = document.getElementById('tutorial-next');
    const tutorialPrev = document.getElementById('tutorial-prev');
    const tutorialSkip = document.getElementById('tutorial-skip');

    function showTutorialSlide(slideNum) {
      document.querySelectorAll('.tutorial-slide').forEach(slide => {
        slide.classList.add('hidden');
      });
      document.querySelector(`[data-slide="${slideNum}"]`).classList.remove('hidden');
      
      tutorialPrev.classList.toggle('hidden', slideNum === 1);
      tutorialNext.textContent = slideNum === 4 ? "Let's Go!" : "Next";
      currentTutorialSlide = slideNum;
    }

    tutorialNext.addEventListener('click', () => {
      if (currentTutorialSlide === 4) {
        tutorialModal.classList.add('hidden');
        localStorage.setItem('tutorialCompleted', 'true');
      } else {
        showTutorialSlide(currentTutorialSlide + 1);
      }
    });

    tutorialPrev.addEventListener('click', () => {
      if (currentTutorialSlide > 1) {
        showTutorialSlide(currentTutorialSlide - 1);
      }
    });

    tutorialSkip.addEventListener('click', () => {
      tutorialModal.classList.add('hidden');
      localStorage.setItem('tutorialCompleted', 'true');
    });

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        if (currentMode === 'visual') {
          visualForm.dispatchEvent(new Event('submit'));
        } else {
          // Determine which guided input is visible and submit
          if (guidedForm && !guidedForm.parentElement.classList.contains('hidden')) {
              guidedForm.dispatchEvent(new Event('submit'));
          } else if (guidedFormMobile && !guidedFormMobile.parentElement.classList.contains('hidden')) {
              guidedFormMobile.dispatchEvent(new Event('submit'));
          }
        }
      }
      
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        // Custom error toast instead of confirm()
        showError('Press Clear Chat button below the model selector to confirm deletion.', 'Note', 4000);
      }
    });

    document.addEventListener('click', (e) => {
      const templateCard = e.target.closest('.template-card');
      if (templateCard) {
        const templateType = templateCard.dataset.template;
        const template = templates[templateType];
        
        if (template) {
          setMode('visual');
          roleInput.value = template.role;
          taskInput.value = template.task;
          contextInput.value = template.context;
          constraintsInput.value = template.constraints;
          
          sidebar.classList.remove('mobile-open');
          mobileOverlay.classList.remove('active');
          
          setTimeout(() => roleInput.focus(), 100);
        }
      }
    });

    chatContainer.addEventListener('scroll', () => {
      if (chatContainer.scrollTop > 300) {
        scrollToTopBtn.classList.add('show');
      } else {
        scrollToTopBtn.classList.remove('show');
      }
    });

    scrollToTopBtn.addEventListener('click', () => {
      chatContainer.scrollTo({ top: 0, behavior: 'smooth' });
    });

    window.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('privacy-modal');
      const closeBtn = document.getElementById('close-modal-btn');
      const dismissCheckbox = document.getElementById('dismiss-forever');

      if (!localStorage.getItem('tutorialCompleted')) {
        setTimeout(() => {
          tutorialModal.classList.remove('hidden');
          showTutorialSlide(1);
        }, 500);
      }

      if (!localStorage.getItem('privacyDismissed')) {
        modal.classList.remove('hidden');
      }

      closeBtn.addEventListener('click', () => {
        if (dismissCheckbox.checked) {
          localStorage.setItem('privacyDismissed', 'true');
        }
        modal.classList.add('hidden');
      });

      helpBtn.addEventListener('click', () => {
        helpDrawer.classList.toggle('hidden');
      });

      // Fix tooltip positioning
      document.querySelectorAll('.tooltip').forEach(tooltip => {
        tooltip.addEventListener('mouseenter', function() {
          const tooltipText = this.querySelector('.tooltiptext');
          if (tooltipText) {
            const rect = this.getBoundingClientRect();
            const tooltipRect = tooltipText.getBoundingClientRect();
            
            tooltipText.classList.remove('right-aligned', 'left-aligned');
            
            if (rect.left + tooltipRect.width / 2 > window.innerWidth) {
              tooltipText.classList.add('right-aligned');
            } else if (rect.left - tooltipRect.width / 2 < 0) {
              tooltipText.classList.add('left-aligned');
            }
          }
        });
      });

      loadHistory();
      setMode(localStorage.getItem('lastMode') || 'guided');
    });

    function autoScroll() {
      const anchor = document.getElementById('chat-anchor');
      if (anchor) {
        setTimeout(() => {
          anchor.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }, 100);
      }
    }

    function removePlaceholder() {
      const placeholder = document.getElementById('placeholder');
      if (placeholder) {
        placeholder.remove();
      }
    }

    function setMode(mode) {
      currentMode = mode;
      localStorage.setItem('lastMode', mode);

      if (mode === 'visual') {
        visualForm.classList.remove('hidden');
        if (guidedForm) guidedForm.parentElement.classList.add('hidden');
        visualModeBtn.classList.add('active');
        guidedModeBtn.classList.remove('active');
      } else {
        visualForm.classList.add('hidden');
        if (guidedForm) guidedForm.parentElement.classList.remove('hidden');
        guidedModeBtn.classList.add('active');
        visualModeBtn.classList.remove('active');
      }
    }

    visualModeBtn.addEventListener('click', () => {
      setMode('visual');
      sidebar.classList.remove('mobile-open');
      mobileOverlay.classList.remove('active');
    });
    
    guidedModeBtn.addEventListener('click', () => {
      setMode('guided');
      sidebar.classList.remove('mobile-open');
      mobileOverlay.classList.remove('active');
    });

    // ==========================================================
    // START: ADDED/UPDATED JS FUNCTIONS
    // ==========================================================

    // Input validation function (IMPROVED to catch gibberish more reliably)
    function validateInput(text) {
      const trimmed = text.trim();
      
      // 1. Check if input is empty or too short
      if (trimmed.length < 3) {
        return { valid: false, error: 'Please provide a little more detail.' };
      }
      
      // 2. Check for simple greetings, which are acceptable starting points
      // Check for common greetings or the "none" keyword
      const simpleKeywords = /^(hi|hello|hey|start|none|no|skip|ready|generate)+(!|\.|\?| )?$/i;
      if (simpleKeywords.test(trimmed) && conversationHistory.length < 5) { // Allow simple responses early on
        return { valid: true };
      }

      // 3. Check for repeated characters (e.g., "aaaaaaaa", "sgsgsg")
      const repeatedPattern = /^(.)\1{4,}$|(\w{2,})\2{2,}/i;
      if (repeatedPattern.test(trimmed)) {
        return { valid: false, error: 'Please type actual words, not random keys.' };
      }
      
      // 4. Check for only non-alphabetic characters or purely numeric
      const hasMeaningfulContent = /[a-zA-Z]{3,}/.test(trimmed);
      if (!hasMeaningfulContent && !/(\d+)/.test(trimmed)) {
        return { valid: false, error: 'Please use actual words to describe your needs.' };
      }
      
      return { valid: true };
    }

    // Show temporary error toast (Updated to handle different types of messages)
    function showError(message, type = 'Error', duration = 3000) {
      const color = type === 'Note' ? 'bg-blue-500' : 'bg-red-500';
      
      const toast = document.createElement('div');
      toast.className = `fixed top-20 left-1/2 -translate-x-1/2 ${color} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fadeIn`;
      toast.textContent = `${type}: ${message}`;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }
    
    // Clean unwanted content from AI responses
    function cleanAIResponse(content) {
      if (typeof content !== 'string') return content;
      
      // Remove solution matrices and recommended paths
      const unwantedSections = [
        /### Solution Matrix[\s\S]*?(?=###|$)/gi,
        /### Recommended Path[\s\S]*?(?=###|$)/gi,
        /\| Solution \|[\s\S]*?(?=###|$)/gi,
        /```json[\s\S]*?```/gi,
        /```[\s\S]*?```/gi
      ];
      
      let cleaned = content;
      unwantedSections.forEach(pattern => {
        cleaned = cleaned.replace(pattern, '');
      });
      
      // Clean up multiple blank lines
      cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
      
      return cleaned.trim();
    }

    // New/Updated function to display assistant messages with conversational distinction
    function displayAssistantMessage(content, explanation, qualityScore) {
      const msg = document.createElement('div');
      msg.className = 'flex justify-start';
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-bubble assistant-bubble';
      
      // Check if the message is a simple question/greeting from guided mode
      const isSimpleQuestion = !content.includes('### Prompt') && !explanation && !qualityScore;

      // Header with quality badge if available
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between mb-3';
      
      const headerText = document.createElement('div');
      headerText.className = 'text-xs font-semibold text-gray-500';

      if (isSimpleQuestion) {
        // Use a friendly title for conversational steps
        headerText.textContent = 'PROMPT COACH'; 
      } else {
        // Use the default title for the final prompt output
        headerText.textContent = 'AI SUGGESTION';
      }
      header.appendChild(headerText);
      
      // Add quality score badge
      if (qualityScore && qualityScore.overall_score) {
        const badge = document.createElement('div');
        badge.className = `px-3 py-1 rounded-full text-xs font-bold ${getScoreBadgeClass(qualityScore.overall_score)}`;
        badge.textContent = `${qualityScore.grade} (${qualityScore.overall_score}/100)`;
        badge.title = `${qualityScore.estimated_success_rate}`;
        header.appendChild(badge);
      }
      
      if (!isSimpleQuestion) { // Only show the header if it's the final prompt or has a score
        messageDiv.appendChild(header);
      }
      
      // Content
      if (isSimpleQuestion) {
        // Use <p> for a cleaner, conversational look
        const contentP = document.createElement('p');
        contentP.className = 'text-sm text-gray-900 whitespace-pre-wrap';
        contentP.textContent = content;
        messageDiv.appendChild(contentP);
      } else {
        // Use <pre> for the final, structured, code-like prompt
        const contentPre = document.createElement('pre');
        contentPre.className = 'text-sm text-gray-900 whitespace-pre-wrap';
        contentPre.textContent = content;
        messageDiv.appendChild(contentPre);
        messageDiv.appendChild(header); // Re-add header here to keep it with prompt content
      }


      // Quality Score Details (collapsible)
      if (qualityScore) {
        const qualitySection = createQualityScoreSection(qualityScore);
        messageDiv.appendChild(qualitySection);
      }
      
      // Explanation section
      if (explanation) {
        const explanationBtn = document.createElement('button');
        explanationBtn.className = 'mt-3 text-xs text-gray-600 hover:text-black font-medium';
        explanationBtn.textContent = 'View Explanation';
        explanationBtn.onclick = function() {
          const explanationDiv = this.nextElementSibling;
          explanationDiv.classList.toggle('hidden');
          this.textContent = explanationDiv.classList.contains('hidden') ? 'View Explanation' : 'Hide Explanation';
        };
        
        const explanationDiv = document.createElement('div');
        explanationDiv.className = 'hidden mt-2 p-3 bg-gray-100 rounded text-xs text-gray-700 whitespace-pre-wrap';
        explanationDiv.textContent = explanation;
        
        messageDiv.appendChild(explanationBtn);
        messageDiv.appendChild(explanationDiv);
      }

      // Action buttons
      if (!isSimpleQuestion) { // Only show copy/refine/delete on the final prompt
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'mt-3 flex gap-3 text-xs text-gray-500';
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'hover:text-black font-medium';
        copyBtn.textContent = 'üìã Copy';
        copyBtn.onclick = function() {
          // Use document.execCommand for better compatibility in limited environments
          const tempTextArea = document.createElement('textarea');
          tempTextArea.value = content;
          document.body.appendChild(tempTextArea);
          tempTextArea.select();
          try {
            document.execCommand('copy');
            const original = this.innerHTML;
            this.innerHTML = '‚úì Copied!';
            setTimeout(() => this.innerHTML = original, 2000);
          } catch (err) {
            showError('Could not copy text to clipboard.', 'Error', 4000);
          }
          document.body.removeChild(tempTextArea);
        };

        // Refine button
        const refineBtn = document.createElement('button');
        refineBtn.className = 'hover:text-black font-medium';
        refineBtn.textContent = '‚ú® Refine';
        refineBtn.onclick = function() {
          showRefineDialog(content);
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'hover:text-black font-medium';
        deleteBtn.textContent = 'üóëÔ∏è Delete';
        deleteBtn.onclick = function() {
          // Replacing confirm() with a custom message box for better UX
          showError('Please use the "Clear Chat" button to manage history.', 'Note', 4000);
        };
        
        actionsDiv.appendChild(copyBtn);
        actionsDiv.appendChild(refineBtn);
        actionsDiv.appendChild(deleteBtn);
        messageDiv.appendChild(actionsDiv);
      }
      
      msg.appendChild(messageDiv);
      const anchor = document.getElementById('chat-anchor');
      anchor.before(msg);
      autoScroll();
    }

    function getScoreBadgeClass(score) {
      if (score >= 90) return 'bg-green-100 text-green-800';
      if (score >= 80) return 'bg-blue-100 text-blue-800';
      if (score >= 70) return 'bg-yellow-100 text-yellow-800';
      if (score >= 60) return 'bg-orange-100 text-orange-800';
      return 'bg-red-100 text-red-800';
    }

    function getScoreColor(score) {
      if (score >= 90) return 'text-green-600';
      if (score >= 80) return 'text-blue-600';
      if (score >= 70) return 'text-yellow-600';
      if (score >= 60) return 'text-orange-600';
      return 'text-red-600';
    }

    function getProgressBarColor(score) {
      if (score >= 90) return 'bg-green-500';
      if (score >= 80) return 'bg-blue-500';
      if (score >= 70) return 'bg-yellow-500';
      if (score >= 60) return 'bg-orange-500';
      return 'bg-red-500';
    }

    function createQualityScoreSection(qualityScore) {
      const section = document.createElement('div');
      section.className = 'mt-3 border-t border-gray-200 pt-3';
      
      // Toggle button
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'text-xs text-gray-600 hover:text-black font-medium flex items-center gap-1';
      toggleBtn.innerHTML = 'üìä View Quality Analysis <span class="text-gray-400">‚ñº</span>';
      
      // Details container (initially hidden)
      const detailsDiv = document.createElement('div');
      detailsDiv.className = 'hidden mt-3 space-y-3';
      
      // Overall score summary
      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'bg-gray-50 rounded-lg p-3';
      summaryDiv.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-semibold">Overall Quality</span>
          <span class="text-lg font-bold ${getScoreColor(qualityScore.overall_score)}">${qualityScore.overall_score}/100</span>
        </div>
        <div class="text-xs text-gray-600">${qualityScore.estimated_success_rate}</div>
      `;
      detailsDiv.appendChild(summaryDiv);
      
      // Dimension scores with progress bars
      if (qualityScore.dimensions) {
        const dimensionsDiv = document.createElement('div');
        dimensionsDiv.className = 'space-y-2';
        
        for (const [dimension, data] of Object.entries(qualityScore.dimensions)) {
          const dimDiv = document.createElement('div');
          dimDiv.innerHTML = `
            <div class="flex items-center justify-between text-xs mb-1">
              <span class="font-medium capitalize">${dimension}</span>
              <span class="text-gray-600">${data.score}/100</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="h-2 rounded-full ${getProgressBarColor(data.score)}" style="width: ${data.score}%"></div>
            </div>
            <div class="text-xs text-gray-500 mt-1">${data.feedback}</div>
          `;
          dimensionsDiv.appendChild(dimDiv);
        }
        
        detailsDiv.appendChild(dimensionsDiv);
      }
      
      // Strengths
      if (qualityScore.strengths && qualityScore.strengths.length > 0) {
        const strengthsDiv = document.createElement('div');
        strengthsDiv.className = 'bg-green-50 rounded-lg p-3';
        strengthsDiv.innerHTML = `
          <div class="text-xs font-semibold text-green-800 mb-2">‚úì Strengths</div>
          <ul class="text-xs text-green-700 space-y-1 pl-4 list-disc list-inside">
            ${qualityScore.strengths.map(s => `<li>${s}</li>`).join('')}
          </ul>
        `;
        detailsDiv.appendChild(strengthsDiv);
      }
      
      // Improvement suggestions
      if (qualityScore.suggestions && qualityScore.suggestions.length > 0) {
        const suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'bg-blue-50 rounded-lg p-3';
        suggestionsDiv.innerHTML = `
          <div class="text-xs font-semibold text-blue-800 mb-2">üí° Suggestions</div>
          <ul class="text-xs text-blue-700 space-y-1 pl-4 list-disc list-inside">
            ${qualityScore.suggestions.map(s => `<li>${s}</li>`).join('')}
          </ul>
        `;
        detailsDiv.appendChild(suggestionsDiv);
      }
      
      // Toggle functionality
      toggleBtn.onclick = function() {
        detailsDiv.classList.toggle('hidden');
        const arrow = this.querySelector('span');
        arrow.textContent = detailsDiv.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
      };
      
      section.appendChild(toggleBtn);
      section.appendChild(detailsDiv);
      
      return section;
    }

    function showRefineDialog(currentPrompt) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full p-6">
          <h3 class="text-lg font-semibold mb-4">Refine Your Prompt</h3>
          <p class="text-sm text-gray-600 mb-4">How would you like to improve this prompt?</p>
          
          <div class="space-y-2 mb-4">
            <button class="refine-option w-full text-left px-4 py-3 rounded-lg border border-gray-200 hover:border-black hover:bg-gray-50 transition" data-refine-action="Make this prompt more specific with concrete details and examples">
              <div class="font-medium text-sm">Make it more specific</div>
              <div class="text-xs text-gray-500">Add more details and concrete examples</div>
            </button>
            
            <button class="refine-option w-full text-left px-4 py-3 rounded-lg border border-gray-200 hover:border-black hover:bg-gray-50 transition" data-refine-action="Make this prompt more technical with advanced terminology and depth">
              <div class="font-medium text-sm">Make it more technical</div>
              <div class="text-xs text-gray-500">Increase depth and technical terminology</div>
            </button>
            
            <button class="refine-option w-full text-left px-4 py-3 rounded-lg border border-gray-200 hover:border-black hover:bg-gray-50 transition" data-refine-action="Simplify this prompt and make it more accessible">
              <div class="font-medium text-sm">Make it simpler</div>
              <div class="text-xs text-gray-500">Simplify language and reduce complexity</div>
            </button>
            
            <button class="refine-option w-full text-left px-4 py-3 rounded-lg border border-gray-200 hover:border-black hover:bg-gray-50 transition" data-refine-action="Add 2-3 concrete examples to this prompt">
              <div class="font-medium text-sm">Add examples</div>
              <div class="text-xs text-gray-500">Include concrete examples and use cases</div>
            </button>
          </div>
          
          <button class="close-modal w-full px-4 py-2 text-sm text-gray-600 hover:text-black font-medium">Cancel</button>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Handle refinement options
      modal.querySelectorAll('.refine-option').forEach((btn) => {
        btn.onclick = async () => {
          const refinement = btn.dataset.refineAction;
          
          modal.remove();
          // The refinement prompt is prepended to the user's message
          await processMessage(`${refinement}. The prompt to be refined is: "${currentPrompt}"`);
        };
      });
      
      modal.querySelector('.close-modal').onclick = () => modal.remove();
      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };
    }

    // Updated processMessage function to handle validation and quality scores
    async function processMessage(userContent) {
      // Step 1: Frontend Validation (for gibberish, etc.)
      const validation = validateInput(userContent);
      if (!validation.valid) {
        showError(validation.error, 'Invalid Input');
        return;
      }
      
      removePlaceholder();
      displayUserMessage(userContent);
      saveHistory('user', userContent);

      const typingBubble = document.createElement('div');
      typingBubble.className = 'flex justify-start';
      typingBubble.innerHTML = '<div class="message-bubble assistant-bubble typing-indicator"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
      const anchor = document.getElementById('chat-anchor');
      anchor.before(typingBubble);
      autoScroll();

      spinner.classList.remove('hidden');

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            messages: conversationHistory,
            target_model: modelSelector.value,
            mode: currentMode
          })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        const data = await response.json();
        
        typingBubble.remove();
        
        // Clean the response before displaying
        const cleanedPrompt = cleanAIResponse(data.expert_prompt);
        
        // Step 2: Display and save assistant response
        displayAssistantMessage(
          cleanedPrompt, 
          data.explanation,
          data.quality_score // Pass quality score if it exists
        );
        saveHistory('assistant', cleanedPrompt);
        
      } catch (error) {
        console.error('Error:', error);
        typingBubble.remove();
        let errorMessage = 'Sorry, something went wrong. Please try again.';
        
        if (error.message.includes('429')) {
          errorMessage = '‚ö†Ô∏è Service is busy. Please wait a moment and try again.';
        } else if (error.message.includes('Network')) {
          errorMessage = '‚ö†Ô∏è Network error. Please check your connection.';
        }
        
        // Display generic error message to the user
        displayAssistantMessage(errorMessage); 
        // Save the error message to history so the flow can continue
        saveHistory('assistant', errorMessage); 
        
      } finally {
        spinner.classList.add('hidden');
      }
    }

    // Enhanced visual form submit with better validation
    visualForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const role = roleInput.value.trim();
      const task = taskInput.value.trim();
      const context = contextInput.value.trim();
      const constraints = constraintsInput.value.trim();

      // Validate task is provided
      if (!task) {
        showError('Please describe the main task.', 'Invalid Input');
        taskInput.focus();
        return;
      }
      
      // Validate task isn't gibberish
      const taskValidation = validateInput(task);
      if (!taskValidation.valid) {
        showError(taskValidation.error, 'Invalid Input');
        taskInput.focus();
        return;
      }
      
      // Build the user idea
      const userIdea = `Role: ${role || 'General AI Assistant'}\nTask: ${task}\nContext: ${context || 'General use case'}\nConstraints: ${constraints || 'None specified'}`;

      // Clear inputs
      roleInput.value = '';
      taskInput.value = '';
      contextInput.value = '';
      constraintsInput.value = '';

      sidebar.classList.remove('mobile-open');
      mobileOverlay.classList.remove('active');

      await processMessage(userIdea);
    });

    // Enhanced guided form validation
    if (guidedForm) {
      guidedForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userMessage = guidedInput.value.trim();
        
        if (!userMessage) return;
        
        const validation = validateInput(userMessage);
        if (!validation.valid) {
          showError(validation.error, 'Invalid Input');
          return;
        }
        
        guidedInput.value = '';
        await processMessage(userMessage);
      });
    }

    if (guidedFormMobile) {
      guidedFormMobile.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userMessage = guidedInputMobile.value.trim();
        
        if (!userMessage) return;
        
        const validation = validateInput(userMessage);
        if (!validation.valid) {
          showError(validation.error, 'Invalid Input');
          return;
        }
        
        guidedInputMobile.value = '';
        await processMessage(userMessage);
      });
    }

    // ==========================================================
    // END: ADDED/UPDATED JS FUNCTIONS
    // ==========================================================

    function displayUserMessage(content) {
      const msg = document.createElement('div');
      msg.className = 'flex justify-end';
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-bubble user-bubble';
      
      const contentPre = document.createElement('pre');
      contentPre.className = 'text-sm';
      contentPre.textContent = content;
      
      messageDiv.appendChild(contentPre);
      
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'mt-2 flex gap-3 text-xs text-gray-400';
      
      const copyBtn = document.createElement('button');
      copyBtn.className = 'hover:text-white font-medium';
      copyBtn.textContent = 'üìã Copy';
      copyBtn.onclick = function() {
        // Use document.execCommand for better compatibility in limited environments
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = content;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        try {
          document.execCommand('copy');
          const original = this.innerHTML;
          this.innerHTML = '‚úì Copied!';
          setTimeout(() => this.innerHTML = original, 2000);
        } catch (err) {
          showError('Could not copy text to clipboard.', 'Error', 4000);
        }
        document.body.removeChild(tempTextArea);
      };
      
      actionsDiv.appendChild(copyBtn);
      messageDiv.appendChild(actionsDiv);
      msg.appendChild(messageDiv);
      
      const anchor = document.getElementById('chat-anchor');
      anchor.before(msg);
      autoScroll();
    }

    function saveHistory(role, content) {
      conversationHistory.push({ role, content });
      localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
    }

    function loadHistory() {
      const saved = localStorage.getItem('chatHistory');
      if (!saved) return;
      
      conversationHistory = JSON.parse(saved);
      
      conversationHistory = conversationHistory.map(msg => {
        if (msg.role === 'assistant' && typeof msg.content === 'object') {
          // Flatten the old structure to simple text content for loading
          return {
            role: 'assistant',
            content: msg.content.expert_prompt || msg.content.explanation || ''
          };
        }
        return msg;
      });
      
      if (conversationHistory.length > 0) {
        removePlaceholder();
        conversationHistory.forEach(msg => {
          if (msg.role === 'user') {
            displayUserMessage(msg.content);
          } else if (msg.role === 'assistant') {
            // Note: Explanation and quality scores are not stored in the simple history, so we pass undefined
            displayAssistantMessage(msg.content); 
          }
        });
      }
      
      localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
    }

    function clearChat() {
      conversationHistory = [];
      localStorage.removeItem('chatHistory');
      chatInner.innerHTML = `
        <div id="placeholder" class="flex flex-col items-center justify-center min-h-[300px] md:min-h-[400px] text-center px-4">
          <div class="w-16 h-16 md:w-20 md:h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center text-white font-bold text-4xl md:text-5xl mb-4 md:mb-6">?</div>
          <h2 class="text-xl md:text-2xl font-semibold text-gray-900 mb-2">Ready to Create Prompts</h2>
          <p class="text-gray-500 text-sm mb-6 md:mb-8">Choose a mode above or try an example below</p>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-2xl">
            <div class="template-card p-3 md:p-4 border-2 border-gray-200 rounded-lg bg-white" data-template="blog">
              <div class="text-2xl mb-2">üìù</div>
              <h3 class="font-semibold text-sm mb-1">Write a Blog Post</h3>
              <p class="text-xs text-gray-600">Create engaging content about any topic</p>
            </div>
            <div class="template-card p-3 md:p-4 border-2 border-gray-200 rounded-lg bg-white" data-template="code">
              <div class="text-2xl mb-2">üíª</div>
              <h3 class="font-semibold text-sm mb-1">Generate Code</h3>
              <p class="text-xs text-gray-600">Build functions, scripts, or applications</p>
            </div>
            <div class="template-card p-3 md:p-4 border-2 border-gray-200 rounded-lg bg-white" data-template="marketing">
              <div class="text-2xl mb-2">üéØ</div>
              <h3 class="font-semibold text-sm mb-1">Marketing Campaign</h3>
              <p class="text-xs text-gray-600">Design promotional content and strategies</p>
            </div>
            <div class="template-card p-3 md:p-4 border-2 border-gray-200 rounded-lg bg-white" data-template="email">
              <div class="text-2xl mb-2">‚úâÔ∏è</div>
              <h3 class="font-semibold text-sm mb-1">Professional Email</h3>
              <p class="text-xs text-gray-600">Craft clear and effective emails</p>
            </div>
          </div>
        </div>
        <div id="chat-anchor"></div>
      `;
    }

    clearChatBtn.addEventListener('click', () => {
      // Replacing confirm() with a custom message box for better UX
      const confirmationModal = document.createElement('div');
      confirmationModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      confirmationModal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl max-w-sm w-full p-6 text-center">
          <h3 class="text-lg font-semibold mb-3">Clear History?</h3>
          <p class="text-sm text-gray-600 mb-6">Are you sure you want to delete all conversation history? This cannot be undone.</p>
          <div class="flex gap-3 justify-center">
            <button id="cancel-clear" class="px-4 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-100 font-medium">Cancel</button>
            <button id="confirm-clear" class="px-4 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">Clear Chat</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmationModal);
      
      document.getElementById('cancel-clear').onclick = () => confirmationModal.remove();
      document.getElementById('confirm-clear').onclick = () => {
        clearChat();
        confirmationModal.remove();
      };

      confirmationModal.onclick = (e) => {
        if (e.target === confirmationModal) confirmationModal.remove();
      };
    });

    // Add CSS for the new UI elements
    const qualityScoreStyles = `
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      .pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
    `;

    const styleSheet = document.createElement('style');
    styleSheet.textContent = qualityScoreStyles;
    document.head.appendChild(styleSheet);
  </script>
</body>
</html>
